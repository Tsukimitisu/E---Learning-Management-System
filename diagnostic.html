<!DOCTYPE html>
<html>
<head>
    <title>ELMS System Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f5f5f5; }
        .card { margin-bottom: 20px; }
        .test-pass { color: #28a745; font-weight: bold; }
        .test-fail { color: #dc3545; font-weight: bold; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
<div class="container">
    <h1>ELMS System Diagnostic Dashboard</h1>
    <p class="text-muted">Check system status and troubleshoot issues</p>

    <div id="results"></div>
</div>

<script>
async function runDiagnostics() {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<p class="text-muted">Running diagnostics...</p>';
    
    try {
        const response = await fetch('diagnostic_api.php');
        const data = await response.json();
        
        let html = '';
        
        // Database Connection
        html += `<div class="card">
            <div class="card-header ${data.database.connected ? 'bg-success' : 'bg-danger'} text-white">
                <h5 class="mb-0">Database Connection</h5>
            </div>
            <div class="card-body">
                <p><strong>Status:</strong> <span class="${data.database.connected ? 'test-pass' : 'test-fail'}">
                    ${data.database.connected ? '✓ Connected' : '✗ Failed'}
                </span></p>
            </div>
        </div>`;
        
        // Student Data
        html += `<div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Student Data</h5>
            </div>
            <div class="card-body">
                <p><strong>Total Students:</strong> ${data.students.total}</p>
                <p><strong>Students with Branch ID:</strong> ${data.students.with_branch_id}</p>
                <p><strong>Students without Branch ID:</strong> ${data.students.without_branch_id}</p>
                ${data.students.by_branch ? `<p><strong>By Branch:</strong></p><pre>${JSON.stringify(data.students.by_branch, null, 2)}</pre>` : ''}
            </div>
        </div>`;
        
        // Branch Admins
        html += `<div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Branch Admins</h5>
            </div>
            <div class="card-body">
                ${data.branch_admins.length > 0 ? `
                    <table class="table table-sm">
                        <thead><tr><th>Name</th><th>Branch</th></tr></thead>
                        <tbody>
                            ${data.branch_admins.map(ba => `<tr>
                                <td>${ba.name}</td>
                                <td>${ba.branch || '<span class="text-danger">Not Assigned</span>'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                ` : '<p>No branch admins found</p>'}
            </div>
        </div>`;
        
        // Registrars
        html += `<div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Registrars</h5>
            </div>
            <div class="card-body">
                ${data.registrars.length > 0 ? `
                    <table class="table table-sm">
                        <thead><tr><th>Name</th><th>Branch</th></tr></thead>
                        <tbody>
                            ${data.registrars.map(r => `<tr>
                                <td>${r.name}</td>
                                <td>${r.branch || '<span class="text-danger">Not Assigned</span>'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                ` : '<p>No registrars found</p>'}
            </div>
        </div>`;
        
        resultsDiv.innerHTML = html;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error running diagnostics: ${error.message}</div>`;
    }
}

// Run on page load
window.addEventListener('load', runDiagnostics);
</script>
</body>
</html>
